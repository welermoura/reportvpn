{% extends 'dashboard/base.html' %}

{% block content %}
<!-- Collapsible Stats & Charts Section -->
<!-- Premium Page Header -->
<div style="display: flex; justifyContent: space-between; align-items: center; margin-bottom: 20px;">
    <h2 style="font-size: 1.4rem; color: white; margin: 0; display: flex; align-items: center; gap: 10px;">
        <span style="font-size: 1.2rem;">üõ°Ô∏è</span> Portal de Seguran√ßa
    </h2>
    <div
        style="display: flex; align-items: center; background: rgba(0,0,0,0.3); padding: 6px 12px; border-radius: 20px; border: 1px solid var(--glass-border);">
        <span class="pulse-live"></span>
        <span style="font-size: 0.7rem; color: #858796; font-weight: 600;">LIVE UPDATING</span>
    </div>
</div>

<!-- Collapsible Stats & Charts Section -->
<!-- Premium Page Header -->
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <h2 style="font-size: 1.4rem; color: white; margin: 0; display: flex; align-items: center; gap: 10px;">
        <span style="font-size: 1.2rem;">üõ°Ô∏è</span> Portal de Seguran√ßa
    </h2>
    <div
        style="display: flex; align-items: center; background: rgba(0,0,0,0.3); padding: 6px 12px; border-radius: 20px; border: 1px solid var(--glass-border);">
        <span class="pulse-live"></span>
        <span style="font-size: 0.7rem; color: #858796; font-weight: 600;">LIVE UPDATING</span>
    </div>
</div>

<!-- Collapsible Stats & Charts Section -->
<div style="margin-bottom: 20px;">
    <button id="toggleChartsBtn" class="premium-card"
        style="width: 100%; text-align: left; padding: 15px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; color: var(--text-primary); border: 1px solid var(--glass-border);">
        <span style="font-weight: 600; display: flex; align-items: center; gap: 10px;">
            üìä Visualizar Gr√°ficos e Estat√≠sticas
        </span>
        <span id="toggleIcon">‚ñº</span>
    </button>
</div>

<div id="chartsContainer" style="display: none; flex-direction: column; gap: 20px; margin-bottom: 30px;">
    <!-- Stats Cards -->
    <div class="stats-grid">
        <div class="stat-card">
            <span class="stat-label">Total de Conex√µes</span>
            <span class="stat-value">{{ page_obj.paginator.count }}</span>
        </div>
        <div class="stat-card">
            <span class="stat-label">Usu√°rios Ativos</span>
            <span class="stat-value" style="color: var(--success-color);">{{ active_users_count|default:"-" }}</span>
        </div>
        <div class="stat-card">
            <span class="stat-label">Volume de Dados</span>
            <span class="stat-value" style="color: var(--accent-color);">{{ total_volume|default:"-" }}</span>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
        <div class="card">
            <div class="card-header">Conex√µes (30 Dias)</div>
            <div style="height: 250px;">
                <canvas id="trendChart"></canvas>
            </div>
        </div>
        <div class="card">
            <div class="card-header">Top Departamentos</div>
            <div style="height: 250px;">
                <canvas id="deptChart"></canvas>
            </div>
        </div>
        <div class="card">
            <div class="card-header" style="color: #f6c23e;">Top Cargos</div>
            <div style="height: 250px;">
                <canvas id="titleChart"></canvas>
            </div>
        </div>
        <div class="card">
            <div class="card-header">Top Usu√°rios (Volume)</div>
            <div style="height: 250px;">
                <canvas id="userChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Toggle Logic
        const btn = document.getElementById('toggleChartsBtn');
        const container = document.getElementById('chartsContainer');
        const icon = document.getElementById('toggleIcon');

        btn.addEventListener('click', () => {
            if (container.style.display === 'none') {
                container.style.display = 'flex';
                icon.textContent = '‚ñ≤';
                btn.style.background = 'rgba(255, 255, 255, 0.1)';
            } else {
                container.style.display = 'none';
                icon.textContent = '‚ñº';
                btn.style.background = 'rgba(255, 255, 255, 0.05)';
            }
        });

        fetch('{% url "dashboard:stats_api" %}')
            .then(response => response.json())
            .then(data => {
                // 1. Trend Chart
                new Chart(document.getElementById('trendChart'), {
                    type: 'line',
                    data: {
                        labels: data.trend.labels,
                        datasets: [{
                            label: 'Conex√µes',
                            data: data.trend.data,
                            borderColor: '#007bff',
                            backgroundColor: 'rgba(0, 123, 255, 0.1)',
                            fill: true,
                            tension: 0.3
                        }]
                    },
                    options: { maintainAspectRatio: false }
                });

                // 2. Dept Chart
                new Chart(document.getElementById('deptChart'), {
                    type: 'doughnut',
                    data: {
                        labels: data.departments.labels,
                        datasets: [{
                            data: data.departments.data,
                            backgroundColor: ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b']
                        }]
                    },
                    options: { maintainAspectRatio: false }
                });

                // 3. Title Chart (New)
                new Chart(document.getElementById('titleChart'), {
                    type: 'pie',
                    data: {
                        labels: data.titles.labels,
                        datasets: [{
                            data: data.titles.data,
                            backgroundColor: ['#f6c23e', '#e74a3b', '#4e73df', '#1cc88a', '#36b9cc']
                        }]
                    },
                    options: { maintainAspectRatio: false }
                });

                // 4. User Chart
                new Chart(document.getElementById('userChart'), {
                    type: 'bar',
                    data: {
                        labels: data.users.labels,
                        datasets: [{
                            label: 'Volume (MB)',
                            data: data.users.data,
                            backgroundColor: '#36b9cc'
                        }]
                    },
                    options: { maintainAspectRatio: false }
                });
            });
    });
</script>

<div class="card">
    <div class="card-header">
        <h2>Hist√≥rico de Acesso</h2>
        <div style="display: flex; gap: 10px; align-items: center;">
            <a href="{% url 'dashboard:export_pdf' %}?{{ request.GET.urlencode }}" class="btn btn-primary"
                style="padding: 5px 15px; font-size: 0.9rem;">
                üìÑ Exportar PDF
            </a>
            <form id="filterForm" method="get" style="display: flex; gap: 10px;">
                <input type="date" name="date" class="form-control" value="{{ request.GET.date|default:'' }}"
                    style="width: auto;">
                <!-- Hidden inputs to maintain state when date changes -->
                <input type="hidden" name="user_q" value="{{ request.GET.user_q|default:'' }}">
                <input type="hidden" name="title_q" value="{{ request.GET.title_q|default:'' }}">
                <input type="hidden" name="dept_q" value="{{ request.GET.dept_q|default:'' }}">
            </form>
        </div>
    </div>

    {% include 'dashboard/partials/logs_table.html' %}
</div>

{% endblock %}