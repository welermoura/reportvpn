{% extends 'dashboard/base.html' %}

{% block content %}
<div id="vpn-dashboard-root"></div>

<!-- React & Dependencies -->
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
    :root {
        --glass-bg: rgba(25, 28, 41, 0.6);
        --glass-border: rgba(255, 255, 255, 0.08);
        --accent-blue: #4e73df;
        --accent-green: #1cc88a;
        --text-secondary: #858796;
    }

    .premium-card {
        background: var(--glass-bg);
        backdrop-filter: blur(15px);
        border: 1px solid var(--glass-border);
        border-radius: 12px;
        box-shadow: 0 4px 20px 0 rgba(0, 0, 0, 0.4);
        transition: all 0.3s ease;
    }

    .stat-value-premium {
        font-size: 1.8rem;
        font-weight: 700;
        color: white;
    }

    .stat-label {
        color: var(--text-secondary);
        font-size: 0.85rem;
        font-weight: 500;
        margin-bottom: 8px;
    }

    .table-premium {
        width: 100%;
        font-family: 'Inter', sans-serif;
        color: rgb(248, 250, 252);
        border-collapse: collapse;
    }

    .table-premium th {
        color: var(--text-secondary);
        font-weight: 600;
        padding: 12px 8px;
        border-bottom: 1px solid var(--glass-border);
        text-align: left;
        white-space: nowrap;
    }

    .table-premium td {
        padding: 12px 8px;
        color: #d1d3e2;
        border-bottom: 1px solid rgba(255, 255, 255, 0.03);
    }

    .table-premium tr:hover {
        background: rgba(255, 255, 255, 0.03);
    }

    .user-avatar {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        background: #4e73df;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        color: white;
        margin-right: 12px;
        font-size: 0.8rem;
    }

    .pulse-live {
        width: 8px;
        height: 8px;
        background: #1cc88a;
        border-radius: 50%;
        display: inline-block;
        box-shadow: 0 0 0 rgba(28, 200, 138, 0.4);
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(28, 200, 138, 0.7); }
        70% { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(28, 200, 138, 0); }
        100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(28, 200, 138, 0); }
    }

    .filter-input {
        background: rgba(15, 23, 42, 0.6);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: #fff;
        padding: 8px 12px;
        border-radius: 6px;
        font-family: 'Inter', sans-serif;
        font-size: 0.85rem;
    }

    .filter-input:focus {
        border-color: #4e73df;
        outline: none;
        box-shadow: 0 0 0 2px rgba(78, 115, 223, 0.2);
    }

    button { cursor: pointer; transition: all 0.2s; }
    button:hover { opacity: 0.9; transform: translateY(-1px); }
</style>

<script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const StatsCharts = ({ data }) => {
        const trendRef = useRef(null);
        useEffect(() => {
            if (!data || !trendRef.current) return;
            const ctx = trendRef.current.getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.connections_trend.map(d => d.date.split('-').reverse().slice(0,2).join('/')),
                    datasets: [{
                        label: 'Conex√µes',
                        data: data.connections_trend.map(d => d.count),
                        borderColor: '#4e73df',
                        backgroundColor: 'rgba(78, 115, 223, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' } }, x: { grid: { display: false } } }
                }
            });
        }, [data]);

        return (
            <div className="premium-card" style={{ padding: '20px', marginBottom: '20px', height: '250px' }}>
                <div style={{ color: 'white', fontWeight: 600, marginBottom: '15px', fontSize: '0.9rem' }}>CONEX√ïES (√öLTIMOS 30 DIAS)</div>
                <canvas ref={trendRef}></canvas>
            </div>
        );
    };

    const VPNDetailsModal = ({ user, onClose }) => {
        const [history, setHistory] = useState([]);
        const [loading, setLoading] = useState(true);

        useEffect(() => {
            fetch(`/api/vpn-logs/history/?user=${user.user}`)
                .then(r => r.json())
                .then(d => { setHistory(d); setLoading(false); });
        }, [user]);

        return (
            <div style={{ position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.8)', zIndex: 1000, display: 'flex', alignItems: 'center', justifyContent: 'center', padding: '20px' }} onClick={onClose}>
                <div className="premium-card" style={{ width: '100%', maxWidth: '900px', maxHeight: '85vh', overflowY: 'auto', padding: '25px', position: 'relative' }} onClick={e => e.stopPropagation()}>
                    <button onClick={onClose} style={{ position: 'absolute', right: '20px', top: '20px', background: 'none', border: 'none', color: 'white', fontSize: '1.5rem' }}>&times;</button>
                    <h3 style={{ color: 'white', marginBottom: '20px' }}>Hist√≥rico: {user.ad_display_name || user.user}</h3>
                    <table className="table-premium">
                        <thead>
                            <tr><th>In√≠cio</th><th>Fim</th><th>Dura√ß√£o</th><th>IP</th><th>Volume</th><th>Status</th></tr>
                        </thead>
                        <tbody>
                            {loading ? <tr><td colSpan="6">Carregando...</td></tr> : history.map(h => (
                                <tr key={h.id}>
                                    <td>{new Date(h.start_time).toLocaleString()}</td>
                                    <td>{h.end_time ? new Date(h.end_time).toLocaleString() : '-'}</td>
                                    <td>{h.formatted_duration || '-'}</td>
                                    <td>{h.source_ip}</td>
                                    <td>{((h.bandwidth_in + h.bandwidth_out)/(1024*1024)).toFixed(2)} MB</td>
                                    <td>{h.status}</td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            </div>
        );
    };

    const VPNDashboard = () => {
        const [logs, setLogs] = useState([]);
        const [stats, setStats] = useState(null);
        const [loading, setLoading] = useState(true);
        const [showCharts, setShowCharts] = useState(false);
        const [selectedUser, setSelectedUser] = useState(null);
        const [currentTime, setCurrentTime] = useState(new Date());
        const [filters, setFilters] = useState({
            user_q: '', title_q: '', dept_q: '',
            date: new Date().toISOString().split('T')[0],
            ordering: '-last_connection'
        });

        const fetchData = useCallback(async () => {
            setLoading(true);
            try {
                const [logsRes, statsRes] = await Promise.all([
                    fetch(`/api/vpn-logs/?user_q=${filters.user_q}&title_q=${filters.title_q}&dept_q=${filters.dept_q}&date=${filters.date}&ordering=${filters.ordering}`),
                    fetch(`/api/stats/?date=${filters.date}`)
                ]);
                const logsData = await logsRes.json();
                const statsData = await statsRes.json();
                setLogs(logsData.logs || []);
                setStats(statsData);
            } catch (err) { console.error(err); }
            setLoading(false);
        }, [filters]);

        useEffect(() => { fetchData(); }, [fetchData]);

        useEffect(() => {
            const ticker = setInterval(() => setCurrentTime(new Date()), 1000);
            const refresh = setInterval(fetchData, 30000);
            return () => { clearInterval(ticker); clearInterval(refresh); };
        }, [fetchData]);

        const handleSort = (field) => {
            setFilters(prev => {
                const isCurrent = prev.ordering === field || prev.ordering === `-${field}`;
                if (!isCurrent) {
                    const textFields = ['user', 'title', 'dept'];
                    const order = textFields.includes(field) ? field : `-${field}`;
                    return { ...prev, ordering: order };
                }
                return { ...prev, ordering: prev.ordering.startsWith('-') ? field : `-${field}` };
            });
        };

        const formatBytes = (b) => {
            if (!b) return "0 B";
            const gb = b / (1024**3);
            return gb >= 1 ? `${gb.toFixed(2)} GB` : `${(b/(1024**2)).toFixed(2)} MB`;
        };

        return (
            <div style={{ padding: '0px' }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
                    <h2 style={{ color: 'white', fontWeight: 700, margin: 0 }}>üîå Relat√≥rio VPN</h2>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '10px', background: 'rgba(0,0,0,0.3)', padding: '6px 15px', borderRadius: '20px', border: '1px solid var(--glass-border)' }}>
                        <span className="pulse-live"></span>
                        <span style={{ fontSize: '0.75rem', color: '#858796', fontWeight: 600 }}>LIVE UPDATING</span>
                    </div>
                </div>

                <div className="premium-card" style={{ marginBottom: '20px', padding: '12px 20px', display: 'flex', justifyContent: 'space-between', cursor: 'pointer' }} onClick={() => setShowCharts(!showCharts)}>
                    <span style={{ color: 'white', fontWeight: 600 }}>üìä Visualizar Gr√°ficos e Estat√≠sticas</span>
                    <span style={{ color: 'white' }}>{showCharts ? '‚ñ≤' : '‚ñº'}</span>
                </div>

                {showCharts && stats && <StatsCharts data={stats} />}

                {stats && (
                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '20px', marginBottom: '20px' }}>
                        <div className="premium-card" style={{ padding: '20px' }}>
                            <div className="stat-label">Conex√µes ({filters.date})</div>
                            <div className="stat-value-premium">{stats.period_stats.total_connections}</div>
                        </div>
                        <div className="premium-card" style={{ padding: '20px' }}>
                            <div className="stat-label">Usu√°rios Ativos</div>
                            <div className="stat-value-premium" style={{ color: 'var(--accent-green)' }}>{stats.period_stats.active_users}</div>
                        </div>
                        <div className="premium-card" style={{ padding: '20px' }}>
                            <div className="stat-label">Volume Total</div>
                            <div className="stat-value-premium" style={{ color: 'var(--accent-blue)' }}>{formatBytes(stats.period_stats.total_volume_bytes)}</div>
                        </div>
                    </div>
                )}

                <div className="premium-card" style={{ padding: '0', overflow: 'hidden' }}>
                    <div style={{ padding: '15px 20px', display: 'flex', gap: '15px', flexWrap: 'wrap', alignItems: 'center', borderBottom: '1px solid var(--glass-border)' }}>
                        <span style={{ color: 'white', fontWeight: 700, fontSize: '0.8rem' }}>FILTROS:</span>
                        <input className="filter-input" placeholder="Usu√°rio..." value={filters.user_q} onChange={e => setFilters({...filters, user_q: e.target.value})} />
                        <input className="filter-input" placeholder="Cargo..." value={filters.title_q} onChange={e => setFilters({...filters, title_q: e.target.value})} />
                        <input className="filter-input" placeholder="Setor..." value={filters.dept_q} onChange={e => setFilters({...filters, dept_q: e.target.value})} />
                        <input className="filter-input" type="date" value={filters.date} onChange={e => setFilters({...filters, date: e.target.value})} style={{ colorScheme: 'dark' }} />
                        <button className="filter-input" style={{ background: '#4e73df', border: 'none', color: 'white' }} onClick={() => fetchData()}>üîç Buscar</button>
                        <button className="filter-input" style={{ background: '#858796', border: 'none', color: 'white' }} onClick={() => setFilters({user_q:'', title_q:'', dept_q:'', date: new Date().toISOString().split('T')[0], ordering:'-last_connection'})}>üßπ Limpar</button>
                    </div>

                    <div style={{ overflowX: 'auto', padding: '0 15px 15px' }}>
                        <table className="table-premium">
                            <thead>
                                <tr>
                                    <th style={{ cursor: 'pointer' }} onClick={() => handleSort('user')}>Usu√°rio</th>
                                    <th style={{ cursor: 'pointer' }} onClick={() => handleSort('title')}>Cargo</th>
                                    <th style={{ cursor: 'pointer' }} onClick={() => handleSort('dept')}>Depto</th>
                                    <th style={{ cursor: 'pointer' }} onClick={() => handleSort('connections')}>Conex√µes</th>
                                    <th style={{ cursor: 'pointer' }} onClick={() => handleSort('last_connection')}>Visto em</th>
                                    <th>Volume</th>
                                    <th>Cidade</th>
                                    <th>Dura√ß√£o</th>
                                    <th style={{ width: '50px' }}></th>
                                </tr>
                            </thead>
                            <tbody>
                                {loading ? <tr><td colSpan="9" style={{ textAlign: 'center', padding: '50px' }}>Carregando...</td></tr> : 
                                 logs.map(l => {
                                    const isActive = (l.latest_status === 'active' || l.online_priority === 1);
                                    let dur = l.total_duration || 0;
                                    if(isActive) {
                                        const start = new Date(l.last_connection);
                                        const diff = Math.floor((currentTime - start) / 1000);
                                        if(diff > 0) dur += diff;
                                    }
                                    const h = Math.floor(dur/3600);
                                    const m = Math.floor((dur%3600)/60);
                                    const s = dur % 60;

                                    return (
                                        <tr key={l.user}>
                                            <td>
                                                <div style={{ display: 'flex', alignItems: 'center' }}>
                                                    <div className="user-avatar">{l.user.substring(0,2).toUpperCase()}</div>
                                                    <div>
                                                        <div style={{ color: 'white', fontWeight: 600, display: 'flex', alignItems: 'center', gap: '8px' }}>
                                                            {l.ad_display_name || l.user}
                                                            {isActive && <span style={{ fontSize: '0.6rem', background: 'rgba(28,200,138,0.2)', color: '#1cc88a', padding: '1px 5px', borderRadius: '4px', border: '1px solid rgba(28,200,138,0.3)' }}>ON</span>}
                                                        </div>
                                                        <div style={{ fontSize: '0.7rem', color: '#858796' }}>{l.user}</div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>{l.ad_title || '-'}</td>
                                            <td>{l.ad_department || '-'}</td>
                                            <td style={{ fontWeight: 700 }}>{l.total_connections}</td>
                                            <td>{new Date(l.last_connection).toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' })}</td>
                                            <td style={{ color: '#4e73df' }}>{formatBytes(l.total_volume)} {isActive && <span className="pulse-live" style={{ width: '5px', height: '5px' }}></span>}</td>
                                            <td style={{ fontSize: '0.85rem' }}>{l.latest_city || '-'} ({l.latest_country_code || '??'})</td>
                                            <td style={{ fontVariantNumeric: 'tabular-nums', color: isActive ? '#1cc88a' : 'inherit' }}>
                                                {h}h {m}m {s}s {isActive && <span className="pulse-live" style={{ width: '5px', height: '5px', marginLeft: '5px' }}></span>}
                                            </td>
                                            <td>
                                                <button style={{ background: 'rgba(255,255,255,0.1)', border: 'none', color: 'white', padding: '5px 10px', borderRadius: '4px' }} onClick={() => setSelectedUser(l)}>üëÅÔ∏è</button>
                                            </td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>
                </div>

                {selectedUser && <VPNDetailsModal user={selectedUser} onClose={() => setSelectedUser(null)} />}
            </div>
        );
    };

    const root = ReactDOM.createRoot(document.getElementById('vpn-dashboard-root'));
    root.render(<VPNDashboard />);
</script>
{% endblock %}
