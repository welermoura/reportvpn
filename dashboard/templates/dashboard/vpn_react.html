{% extends 'dashboard/base.html' %}

{% block content %}
<div id="vpn-dashboard-root"></div>

<!-- React & Dependencies -->
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<!-- Custom Styles for Premium Look -->
<style>
    :root {
        --glass-bg: rgba(25, 28, 41, 0.6);
        --glass-border: rgba(255, 255, 255, 0.08);
        --accent-blue: #4e73df;
        --accent-green: #1cc88a;
        --text-secondary: #858796;
    }

    .premium-card {
        background: var(--glass-bg);
        backdrop-filter: blur(15px);
        border: 1px solid var(--glass-border);
        border-radius: 12px;
        box-shadow: 0 4px 20px 0 rgba(0, 0, 0, 0.4);
        transition: all 0.3s ease;
    }

    .stat-value-premium {
        font-size: 1.8rem;
        font-weight: 700;
        color: white;
    }

    .stat-label {
        color: var(--text-secondary);
        font-size: 0.85rem;
        font-weight: 500;
        margin-bottom: 8px;
    }

    .chart-box {
        background: var(--glass-bg);
        border-radius: 12px;
        border: 1px solid var(--glass-border);
        padding: 20px;
        height: 300px;
    }

    .chart-title {
        font-size: 0.9rem;
        font-weight: 600;
        color: white;
        margin-bottom: 20px;
    }

    .table-premium {
        width: 100%;
        font-family: 'Inter', sans-serif;
        font-size: 16px;
        font-weight: 400;
        color: rgb(248, 250, 252);
        border-collapse: collapse;
    }

    .table-premium th {
        color: var(--text-secondary);
        font-weight: 600;
        padding: 12px 8px;
        border-bottom: 1px solid var(--glass-border);
        text-align: left;
        white-space: nowrap;
    }

    .table-premium td {
        padding: 12px 8px;
        color: #d1d3e2;
        border-bottom: 1px solid rgba(255, 255, 255, 0.03);
    }

    .table-premium tr:hover {
        background: rgba(255, 255, 255, 0.03);
    }

    .user-avatar {
        width: 30px;
        height: 30px;
        border-radius: 6px;
        background: #4e73df;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        color: white;
        margin-right: 8px;
        font-size: 0.7rem;
    }

    .btn-pdf {
        background: #4e73df;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.8rem;
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-pdf:hover {
        background: #2e59d9;
        transform: translateY(-1px);
    }

    .filter-input-cell {
        background: rgba(0, 0, 0, 0.3) !important;
        border: 1px solid var(--glass-border) !important;
        color: white !important;
        font-size: 0.75rem !important;
        padding: 4px 8px !important;
        border-radius: 4px !important;
        width: 100%;
    }

    .filter-input-cell::placeholder {
        color: #5a5c69;
    }

    /* Make calendar icon visible on dark theme */
    .filter-input-cell::-webkit-calendar-picker-indicator {
        filter: invert(1);
        cursor: pointer;
        opacity: 0.6;
        transition: opacity 0.2s;
    }

    .filter-input-cell::-webkit-calendar-picker-indicator:hover {
        opacity: 1;
    }

    .filter-input-premium {
        background: rgba(0, 0, 0, 0.3) !important;
        border: 1px solid var(--glass-border) !important;
        color: white !important;
        font-size: 0.8rem !important;
        padding: 5px 12px !important;
        /* Adjusted padding for alignment */
        border-radius: 6px !important;
        cursor: pointer;
        height: 35px;
        /* Match button height (approx 35-37px) */
        box-sizing: border-box;
        font-family: 'Inter', sans-serif;
    }

    .filter-input-premium::-webkit-calendar-picker-indicator {
        filter: invert(1);
        cursor: pointer;
        opacity: 0.6;
    }

    .pulse-live {
        width: 8px;
        height: 8px;
        background: #1cc88a;
        border-radius: 50%;
        display: inline-block;
        margin-right: 8px;
        box-shadow: 0 0 0 rgba(28, 200, 138, 0.4);
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0% {
            transform: scale(0.95);
            box-shadow: 0 0 0 0 rgba(28, 200, 138, 0.7);
        }

        70% {
            transform: scale(1.1);
            box-shadow: 0 0 0 10px rgba(28, 200, 138, 0);
        }

        100% {
            transform: scale(0.95);
            box-shadow: 0 0 0 0 rgba(28, 200, 138, 0);
        }
    }

    /* Filter Bar Styles from Webfilter */
    .filters-bar {
        background: transparent;
        padding: 10px 0;
        margin-bottom: 15px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        align-items: center;
        gap: 15px;
        flex-wrap: wrap;
    }

    .filters-label {
        font-weight: bold;
        color: #fff;
        margin-right: 10px;
        text-transform: uppercase;
        font-size: 0.9rem;
    }

    .filter-input {
        background: rgba(15, 23, 42, 0.6);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: #fff;
        padding: 6px 12px;
        border-radius: 4px;
        min-width: 150px;
        font-family: 'Inter', sans-serif;
    }

    .filter-input::placeholder {
        color: #858796;
    }

    .filter-input:focus {
        border-color: #4e73df;
        outline: none;
    }

    /* Reuse filter-input-premium style but rename for consistency if needed, 
       or just use filter-input. Let's stick to the new class for consistency with plan. */

    .btn-sm {
        padding: 6px 12px;
        font-size: 0.85rem;
    }

    .btn-primary {
        background-color: #4e73df;
        border-color: #4e73df;
        color: white;
        border-radius: 4px;
        cursor: pointer;
        border: 1px solid transparent;
    }

    .btn-success {
        background-color: #1cc88a;
        border-color: #1cc88a;
        color: white;
        border-radius: 4px;
        cursor: pointer;
        border: 1px solid transparent;
    }

    .btn-secondary {
        background-color: #858796;
        border-color: #858796;
        color: white;
        border-radius: 4px;
        cursor: pointer;
        border: 1px solid transparent;
    }

    /* Timeline Styles */
    .timeline-container {
        position: relative;
        padding: 20px 0;
    }

    .timeline-item {
        position: relative;
        padding-left: 40px;
        margin-bottom: 25px;
    }

    .timeline-line {
        position: absolute;
        left: 11px;
        top: 25px;
        bottom: -25px;
        width: 2px;
        background: rgba(255, 255, 255, 0.1);
    }

    .timeline-item:last-child .timeline-line {
        display: none;
    }

    .timeline-dot {
        position: absolute;
        left: 0;
        top: 0;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
        z-index: 2;
    }

    .timeline-content {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.05);
        border-radius: 8px;
        padding: 15px;
        transition: transform 0.2s;
    }

    .timeline-content:hover {
        background: rgba(255, 255, 255, 0.06);
        transform: translateX(5px);
    }

    .tab-btn {
        background: transparent;
        border: none;
        color: #858796;
        padding: 10px 20px;
        font-weight: 600;
        cursor: pointer;
        border-bottom: 2px solid transparent;
        font-size: 0.95rem;
        transition: all 0.2s;
    }

    .tab-btn.active {
        color: #4e73df;
        border-bottom-color: #4e73df;
    }

    .tab-btn:hover {
        color: white;
    }
</style>

<script type="text/babel">
    {% verbatim %}
    const { useState, useEffect, useCallback, useRef } = React;

    // ... StatsCharts Component (unchanged) ...
    const StatsCharts = ({ data }) => {
        if (!data) return null;

        const trendRef = useRef(null);
        const deptRef = useRef(null);
        const titleRef = useRef(null);
        const userRef = useRef(null);
        const failureRef = useRef(null);
        const charInstances = useRef({});

        useEffect(() => {
            if (!data) return;
            // Ensure charInstances is initialized
            if (!charInstances.current) charInstances.current = {};

            Object.values(charInstances.current).forEach(c => c && c.destroy());

            const chartOptions = {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { labels: { color: '#858796', font: { size: 10 } } } }
            };

            charInstances.current.trend = new Chart(trendRef.current, {
                type: 'line',
                data: {
                    labels: data.trend.labels,
                    datasets: [{ label: 'Conex√µes', data: data.trend.data, borderColor: '#4e73df', fill: false, tension: 0.3 }]
                },
                options: {
                    ...chartOptions,
                    plugins: { legend: { display: false } },
                    scales: { y: { ticks: { color: '#858796' }, grid: { color: 'rgba(255,255,255,0.05)' } }, x: { ticks: { color: '#858796' }, grid: { display: false } } },
                    onClick: (e, elements) => {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            const dateValue = data.trend.keys ? data.trend.keys[index] : null;
                            if (dateValue) setFilters(f => ({ ...f, date: dateValue }));
                        }
                    }
                }
            });

            charInstances.current.dept = new Chart(deptRef.current, {
                type: 'doughnut',
                data: { labels: data.departments.labels, datasets: [{ data: data.departments.data, backgroundColor: ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b'] }] },
                options: { ...chartOptions, plugins: { legend: { position: 'right' } }, cutout: '70%' }
            });

            charInstances.current.title = new Chart(titleRef.current, {
                type: 'doughnut',
                data: { labels: data.titles.labels, datasets: [{ data: data.titles.data, backgroundColor: ['#f6c23e', '#e74a3b', '#4e73df', '#1cc88a', '#36b9cc'] }] },
                options: { ...chartOptions, plugins: { legend: { position: 'right' } }, cutout: '70%' }
            });

            charInstances.current.user = new Chart(userRef.current, {
                type: 'bar',
                data: { labels: data.users.labels, datasets: [{ label: 'MB', data: data.users.data, backgroundColor: '#36b9cc' }] },
                options: { ...chartOptions, plugins: { legend: { display: false } }, scales: { y: { ticks: { color: '#858796' }, grid: { color: 'rgba(255,255,255,0.05)' } }, x: { ticks: { color: '#858796' }, grid: { display: false } } } }
            });

            if (data.failures && data.failures.labels.length > 0) {
                charInstances.current.failure = new Chart(failureRef.current, {
                    type: 'bar',
                    data: { labels: data.failures.labels, datasets: [{ label: 'Falhas', data: data.failures.data, backgroundColor: '#e74a3b' }] },
                    options: {
                        ...chartOptions,
                        plugins: { legend: { display: false }, title: { display: false } },
                        scales: { y: { ticks: { color: '#858796' }, grid: { color: 'rgba(255,255,255,0.05)' } }, x: { ticks: { color: '#858796' }, grid: { display: false } } }
                    }
                });
            }

            return () => Object.values(charInstances.current).forEach(c => c.destroy());
        }, [data]);

        return (
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(280px, 1fr))', gap: '20px', marginBottom: '30px' }}>
                <div className="chart-box">
                    <div className="chart-title">Conex√µes (30 Dias)</div>
                    <div style={{ height: '220px' }}><canvas ref={trendRef}></canvas></div>
                </div>
                <div className="chart-box">
                    <div className="chart-title">Top Departamentos</div>
                    <div style={{ height: '220px' }}><canvas ref={deptRef}></canvas></div>
                </div>
                <div className="chart-box">
                    <div className="chart-title">Top Cargos</div>
                    <div style={{ height: '220px' }}><canvas ref={titleRef}></canvas></div>
                </div>
                <div className="chart-box">
                    <div className="chart-title">Top Usu√°rios (Volume)</div>
                    <div style={{ height: '220px' }}><canvas ref={userRef}></canvas></div>
                </div>
            </div>
        );
    };

    const TimelineItem = ({ event }) => {
        let icon = 'üîå';
        let color = '#4e73df';
        let bg = 'rgba(78, 115, 223, 0.2)';

        if (event.type === 'security') {
            if (event.subtype === 'ips') { icon = 'üõ°Ô∏è'; color = '#e74a3b'; bg = 'rgba(231, 74, 59, 0.2)'; }
            else if (event.subtype === 'antivirus') { icon = 'ü¶†'; color = '#f6c23e'; bg = 'rgba(246, 194, 62, 0.2)'; }
            else if (event.subtype === 'webfilter') { icon = 'üö´'; color = '#e74a3b'; bg = 'rgba(231, 74, 59, 0.2)'; }
            else if (event.subtype === 'bruteforce') { icon = 'üö®'; color = '#e74a3b'; bg = 'rgba(231, 74, 59, 0.2)'; }
        } else if (event.type === 'vpn_failure') {
            icon = 'üîê'; color = '#f6c23e'; bg = 'rgba(246, 194, 62, 0.2)';
        }

        // Impossible Travel Override
        if (event.details?.impossible_travel) {
            icon = '‚úàÔ∏è'; color = '#e74a3b'; bg = 'rgba(231, 74, 59, 0.2)';
        }

        return (
            <div className="timeline-item">
                <div className="timeline-line"></div>
                <div className="timeline-dot" style={{ background: bg, color: color, boxShadow: `0 0 0 4px #1a1d2d` }}>
                    {icon}
                </div>
                <div className="timeline-content" style={{ borderLeft: `3px solid ${color}` }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '5px' }}>
                        <strong style={{ color: 'white' }}>{event.summary}</strong>
                        <span style={{ fontSize: '0.75rem', color: '#858796' }}>
                            {new Date(event.timestamp).toLocaleString('pt-BR')}
                        </span>
                    </div>

                    {event.details?.impossible_travel && (
                        <div style={{ background: 'rgba(231, 74, 59, 0.1)', color: '#e74a3b', padding: '8px', borderRadius: '4px', fontSize: '0.85rem', marginBottom: '8px', border: '1px solid #e74a3b' }}>
                            üö® <b>ALERTA DE VIAGEM IMPOSS√çVEL DETECTADA!</b><br />
                            Mudan√ßa de localiza√ß√£o invi√°vel em curto per√≠odo de tempo.
                        </div>
                    )}

                    {event.subtype === 'bruteforce' && (
                        <div style={{ background: 'rgba(231, 74, 59, 0.1)', color: '#e74a3b', padding: '8px', borderRadius: '4px', fontSize: '0.85rem', marginBottom: '8px', border: '1px solid #e74a3b' }}>
                            üö® <b>ATAQUE DE FOR√áA BRUTA CONFIRMADO!</b><br />
                            M√∫ltiplas falhas de login detectadas em curto per√≠odo.<br />
                            <i>A√ß√£o recomendada: Bloquear usu√°rio e resetar senha.</i>
                        </div>
                    )}

                    <div style={{ fontSize: '0.85rem', color: '#d1d3e2' }}>
                        {event.type === 'vpn' && (
                            <div>
                                <span>Dur: {event.details.duration}</span> ‚Ä¢ <span>IP: {event.details.source_ip}</span>
                            </div>
                        )}
                        {event.type === 'security' && (
                            Object.entries(event.details).map(([k, v]) => (
                                <div key={k}><span style={{ textTransform: 'capitalize', color: '#858796' }}>{k}:</span> {v}</div>
                            ))
                        )}
                    </div>
                </div>
            </div>
        );
    };

    const VPNDetailsModal = ({ user, onClose }) => {
        const [activeTab, setActiveTab] = useState('history');
        const [history, setHistory] = useState([]);
        const [timeline, setTimeline] = useState([]);
        const [loading, setLoading] = useState(true);

        useEffect(() => {
            if (user && user.user) {
                setLoading(true);
                if (activeTab === 'history') {
                    fetch(`/api/vpn-logs/history/?user=${encodeURIComponent(user.user)}`)
                        .then(res => res.json())
                        .then(data => { setHistory(data); setLoading(false); })
                        .catch(err => { console.error(err); setLoading(false); });
                } else {
                    fetch(`/api/user-timeline/?username=${encodeURIComponent(user.user)}`)
                        .then(res => res.json())
                        .then(data => { setTimeline(data); setLoading(false); })
                        .catch(err => { console.error(err); setLoading(false); });
                }
            }
        }, [user, activeTab]);

        if (!user) return null;

        const formatBytes = (bytes) => {
            if (!bytes) return "0 B";
            const gb = bytes / (1024 ** 3);
            return gb >= 1 ? `${gb.toFixed(2)} GB` : `${(bytes / (1024 ** 2)).toFixed(2)} MB`;
        };

        const formatDuration = (seconds) => {
            if (!seconds) return "0s";
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = seconds % 60;
            return h > 0 ? `${h}h ${m}m ${s}s` : `${m}m ${s}s`;
        };

        return (
            <div style={{
                position: 'fixed', top: 0, left: 0, right: 0, bottom: 0,
                background: 'rgba(0,0,0,0.7)', backdropFilter: 'blur(5px)',
                display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000
            }} onClick={onClose}>
                <div style={{
                    background: '#1a1d2d', border: '1px solid rgba(255,255,255,0.1)',
                    borderRadius: '12px', padding: '0', width: '900px', maxWidth: '95%', maxHeight: '90vh',
                    overflowY: 'auto', boxShadow: '0 20px 50px rgba(0,0,0,0.5)', position: 'relative', display: 'flex', flexDirection: 'column'
                }} onClick={e => e.stopPropagation()}>

                    {/* Header Fixed */}
                    <div style={{ padding: '24px 24px 0 24px' }}>
                        <button onClick={onClose} style={{
                            position: 'absolute', top: '15px', right: '15px',
                            background: 'transparent', border: 'none', color: '#fff', fontSize: '1.2rem', cursor: 'pointer'
                        }}>‚úï</button>

                        <h3 style={{ color: 'white', marginTop: 0, marginBottom: '20px' }}>
                            Detalhes do Usu√°rio
                        </h3>

                        {/* Identity Card */}
                        <div style={{ background: 'rgba(255, 255, 255, 0.03)', padding: '20px', borderRadius: '8px', marginBottom: '10px', display: 'flex', alignItems: 'center', gap: '20px' }}>
                            <div style={{ background: '#4e73df', width: '60px', height: '60px', borderRadius: '50%', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '2rem', color: 'white' }}>
                                {user.user.substring(0, 2).toUpperCase()}
                            </div>
                            <div>
                                <div style={{ color: 'white', fontWeight: 700, fontSize: '1.3rem' }}>
                                    {user.ad_display_name || user.user}
                                </div>
                                <div style={{ display: 'flex', gap: '20px', marginTop: '8px', fontSize: '0.9rem', color: '#d1d3e2' }}>
                                    <span>üë§ {user.user}</span>
                                    {user.ad_department && <span>üè¢ {user.ad_department}</span>}
                                    {user.ad_title && <span>üíº {user.ad_title}</span>}
                                </div>
                                <div style={{ marginTop: '10px', display: 'flex', gap: '15px', fontSize: '0.85rem' }}>
                                    <span style={{ background: 'rgba(78, 115, 223, 0.2)', color: '#4e73df', padding: '2px 8px', borderRadius: '4px' }}>
                                        Total Conex√µes: <b>{user.total_connections}</b>
                                    </span>
                                    <span style={{ background: 'rgba(28, 200, 138, 0.2)', color: '#1cc88a', padding: '2px 8px', borderRadius: '4px' }}>
                                        Volume Total: <b>{formatBytes(user.total_volume)}</b>
                                    </span>
                                </div>
                            </div>
                        </div>

                        {/* Tabs */}
                        <div style={{ display: 'flex', borderBottom: '1px solid rgba(255,255,255,0.1)', marginBottom: '20px' }}>
                            <button
                                className={`tab-btn ${activeTab === 'history' ? 'active' : ''}`}
                                onClick={() => setActiveTab('history')}
                            >
                                üìÖ Hist√≥rico de Conex√µes
                            </button>
                            <button
                                className={`tab-btn ${activeTab === 'timeline' ? 'active' : ''}`}
                                onClick={() => setActiveTab('timeline')}
                            >
                                ‚è±Ô∏è Linha do Tempo Unificada
                            </button>
                        </div>
                    </div>

                    {/* Content */}
                    <div style={{ padding: '0 24px 24px 24px', flexGrow: 1, overflowY: 'auto' }}>
                        {loading ? (
                            <div style={{ textAlign: 'center', padding: '30px', color: '#858796' }}>Carregando dados...</div>
                        ) : (
                            activeTab === 'history' ? (
                                <div style={{ overflowX: 'auto' }}>
                                    <table className="table-premium" style={{ fontSize: '0.85rem' }}>
                                        <thead>
                                            <tr>
                                                <th>In√≠cio</th>
                                                <th>Dura√ß√£o</th>
                                                <th>Origem (IP)</th>
                                                <th>Localiza√ß√£o</th>
                                                <th>Device / OS</th>
                                                <th>Volume</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {history.map(h => (
                                                <tr key={h.id}>
                                                    <td>
                                                        <div>{new Date(h.start_time).toLocaleDateString('pt-BR')}</div>
                                                        <div style={{ fontSize: '0.75rem', color: '#858796' }}>{new Date(h.start_time).toLocaleTimeString('pt-BR')}</div>
                                                    </td>
                                                    <td>{formatDuration(h.duration)}</td>
                                                    <td style={{ fontFamily: 'monospace' }}>{h.source_ip}</td>
                                                    <td>
                                                        {h.city ? `${h.city}, ${h.country_code}` : (h.country_name || '-')}
                                                    </td>
                                                    <td>
                                                        <div style={{ fontSize: '0.75rem', color: '#d1d3e2' }}>{h.tunnel_type || '-'}</div>
                                                    </td>
                                                    <td style={{ color: '#4e73df', fontWeight: 600 }}>{formatBytes(h.total_volume)}</td>
                                                </tr>
                                            ))}
                                            {history.length === 0 && (
                                                <tr><td colSpan="6" style={{ textAlign: 'center', padding: '20px' }}>Nenhum registro encontrado.</td></tr>
                                            )}
                                        </tbody>
                                    </table>
                                </div>
                            ) : (
                                <div className="timeline-container">
                                    {timeline.map(item => (
                                        <TimelineItem key={item.id} event={item} />
                                    ))}
                                    {timeline.length === 0 && (
                                        <div style={{ textAlign: 'center', padding: '20px', color: '#858796' }}>Nenhuma atividade registrada na linha do tempo.</div>
                                    )}
                                </div>
                            )
                        )}
                    </div>
                </div>
            </div>
        );
    };

    const VPNDashboard = () => {
        const [logs, setLogs] = useState([]);
        const [stats, setStats] = useState(null);
        const [loading, setLoading] = useState(true);
        const [showCharts, setShowCharts] = useState(true);
        const [selectedUser, setSelectedUser] = useState(null);

        const getHealthiestToday = () => {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        const [filters, setFilters] = useState({
            user_q: '', title_q: '', dept_q: '', date: getHealthiestToday(), ordering: '-last_connection'
        });

        const fetchData = useCallback(async () => {
            try {
                const search = new URLSearchParams(filters).toString();
                const statsSearch = filters.date ? `?date=${filters.date}` : '';

                const [lRes, sRes] = await Promise.all([
                    fetch(`/api/vpn-logs/?${search}`),
                    fetch(`/api/stats/${statsSearch}`)
                ]);
                setLogs(await lRes.json());
                setStats(await sRes.json());
                setLoading(false);
            } catch (err) { console.error(err); }
        }, [filters]);

        useEffect(() => {
            fetchData();
            const interval = setInterval(fetchData, 30000);
            return () => clearInterval(interval);
        }, [fetchData]);

        const formatBytes = (bytes) => {
            if (!bytes) return "0 B";
            const gb = bytes / (1024 ** 3);
            return gb >= 1 ? `${gb.toFixed(2)} GB` : `${(bytes / (1024 ** 2)).toFixed(2)} MB`;
        };

        const handleExport = (type) => {
            const params = new URLSearchParams(filters);
            window.location.href = `/export/${type}/?${params}`;
        };

        const clearFilters = () => {
            setFilters({
                user_q: '', title_q: '', dept_q: '', date: getHealthiestToday(), ordering: '-last_connection'
            });
        };

        return (
            <div style={{ padding: '0px' }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
                    <h2 style={{ fontSize: '1.4rem', color: 'white', margin: 0, display: 'flex', alignItems: 'center', gap: '10px' }}>
                        <span style={{ fontSize: '1.2rem' }}>üîå</span> Relat√≥rio VPN
                    </h2>
                    <div style={{ display: 'flex', alignItems: 'center', background: 'rgba(0,0,0,0.3)', padding: '6px 12px', borderRadius: '20px', border: '1px solid var(--glass-border)' }}>
                        <span className="pulse-live"></span>
                        <span style={{ fontSize: '0.7rem', color: '#858796', fontWeight: 600 }}>LIVE UPDATING</span>
                    </div>
                </div>

                <div className="premium-card" style={{ marginBottom: '20px', padding: '10px 20px', cursor: 'pointer', display: 'flex', justifyContent: 'space-between' }} onClick={() => setShowCharts(!showCharts)}>
                    <span style={{ fontSize: '0.85rem', fontWeight: 600 }}>üìä Visualizar Gr√°ficos e Estat√≠sticas</span>
                    <span>{showCharts ? '‚ñ≤' : '‚ñº'}</span>
                </div>

                {showCharts && stats && (
                    <React.Fragment>
                        <StatsCharts data={stats} />
                        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))', gap: '20px', marginBottom: '30px' }}>
                            <div className="premium-card" style={{ padding: '24px' }}>
                                <div className="stat-label">Total de Conex√µes {filters.date ? `(${filters.date.split('-').reverse().join('/')})` : '(Hoje)'}</div>
                                <div className="stat-value-premium">{stats?.period_stats?.total_connections || 0}</div>
                            </div>
                            <div className="premium-card" style={{ padding: '24px' }}>
                                <div className="stat-label">Usu√°rios Ativos {filters.date ? `(${filters.date.split('-').reverse().join('/')})` : '(Hoje)'}</div>
                                <div className="stat-value-premium" style={{ color: 'var(--accent-green)' }}>{stats?.period_stats?.active_users || 0}</div>
                            </div>
                            <div className="premium-card" style={{ padding: '24px' }}>
                                <div className="stat-label">Volume de Dados {filters.date ? `(${filters.date.split('-').reverse().join('/')})` : '(Hoje)'}</div>
                                <div className="stat-value-premium" style={{ color: 'var(--accent-blue)' }}>{formatBytes(stats?.period_stats?.total_volume_bytes || 0)}</div>
                            </div>
                        </div>
                    </React.Fragment>
                )}

                <div className="premium-card" style={{ padding: '0', overflow: 'hidden', marginBottom: '20px' }}>
                    <div className="filters-bar" style={{ margin: 0, padding: '15px 20px', borderBottom: '1px solid rgba(255, 255, 255, 0.1)' }}>
                        <span className="filters-label">FILTROS:</span>

                        <input
                            type="text"
                            className="filter-input"
                            placeholder="Usu√°rio..."
                            value={filters.user_q}
                            onChange={e => setFilters({ ...filters, user_q: e.target.value })}
                        />

                        <input
                            type="text"
                            className="filter-input"
                            placeholder="Cargo..."
                            value={filters.title_q}
                            onChange={e => setFilters({ ...filters, title_q: e.target.value })}
                        />

                        <input
                            type="text"
                            className="filter-input"
                            placeholder="Departamento..."
                            value={filters.dept_q}
                            onChange={e => setFilters({ ...filters, dept_q: e.target.value })}
                        />

                        <input
                            type="date"
                            className="filter-input"
                            value={filters.date}
                            onChange={e => setFilters({ ...filters, date: e.target.value })}
                            style={{ colorScheme: 'dark' }}
                        />

                        <div style={{ flexGrow: 1 }}></div>

                        <button className="btn btn-primary btn-sm" style={{ marginRight: '8px', display: 'flex', alignItems: 'center', gap: '5px' }} onClick={() => handleExport('pdf')}>
                            üìÑ PDF
                        </button>
                        <button className="btn btn-success btn-sm" style={{ marginRight: '8px', display: 'flex', alignItems: 'center', gap: '5px' }} onClick={() => handleExport('xlsx')}>
                            üìä Excel
                        </button>
                        <button className="btn btn-secondary btn-sm" style={{ display: 'flex', alignItems: 'center', gap: '5px' }} onClick={clearFilters}>
                            üßπ Limpar
                        </button>
                    </div>

                    <div style={{ padding: '0 15px 15px 15px', overflowX: 'auto' }}>
                        <table className="table-premium">
                            <thead>
                                <tr>
                                    <th style={{ width: '220px' }}>Usu√°rio</th>
                                    <th>Cargo</th>
                                    <th>Depto</th>
                                    <th style={{ textAlign: 'center' }}>Qtd Conex√µes</th>
                                    <th>Acesso</th>
                                    <th>Origem</th>
                                    <th>Cidade</th>
                                    <th>Pa√≠s</th>
                                    <th>Volume</th>
                                    <th>Dura√ß√£o</th>
                                    <th>Detalhes</th>
                                </tr>
                            </thead>
                            <tbody>
                                {loading ? (
                                    <tr><td colSpan="11" style={{ textAlign: 'center', padding: '40px' }}>Carregando dados...</td></tr>
                                ) : logs.map(l => (
                                    <tr key={l.user}>
                                        <td>
                                            <div style={{ display: 'flex', alignItems: 'center' }}>
                                                <div className="user-avatar" style={{ position: 'relative' }}>
                                                    {l.user.substring(0, 2).toUpperCase()}
                                                    {l.latest_status === 'active' && (
                                                        <span style={{
                                                            position: 'absolute',
                                                            bottom: '0',
                                                            right: '0',
                                                            width: '10px',
                                                            height: '10px',
                                                            backgroundColor: '#1cc88a',
                                                            borderRadius: '50%',
                                                            border: '2px solid #1a1d2d',
                                                            boxShadow: '0 0 5px rgba(28, 200, 138, 0.8)'
                                                        }} title="Conectado Agora"></span>
                                                    )}
                                                </div>
                                                <div>
                                                    <div style={{ fontWeight: 600, color: 'white', display: 'flex', alignItems: 'center', gap: '8px' }}>
                                                        {l.ad_display_name || l.user}
                                                        {l.latest_status === 'active' && (
                                                            <span style={{
                                                                fontSize: '0.65rem',
                                                                backgroundColor: 'rgba(28, 200, 138, 0.2)',
                                                                color: '#1cc88a',
                                                                padding: '1px 6px',
                                                                borderRadius: '4px',
                                                                border: '1px solid rgba(28, 200, 138, 0.3)'
                                                            }}>ON</span>
                                                        )}
                                                    </div>
                                                    <div style={{ fontSize: '0.7rem', color: '#5a5c69' }}>{l.user}</div>
                                                </div>
                                            </div>
                                        </td>
                                        <td>{l.ad_title || '-'}</td>
                                        <td>{l.ad_department || '-'}</td>
                                        <td style={{ textAlign: 'center', fontWeight: 'bold' }}>{l.total_connections}</td>
                                        <td>{new Date(l.last_connection).toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' })}</td>
                                        <td>{l.latest_source_ip}</td>
                                        <td>{l.latest_city}</td>
                                        <td>{l.latest_country_code || '-'}</td>
                                        <td style={{ color: 'var(--accent-blue)', fontWeight: 600 }}>{formatBytes(l.total_volume)}</td>
                                        <td>{Math.floor((l.total_duration || 0) / 3600)}h {Math.floor(((l.total_duration || 0) % 3600) / 60)}m</td>
                                        <td>
                                            <button
                                                className="btn-sm"
                                                style={{ background: 'rgba(255,255,255,0.1)', border: '1px solid rgba(255,255,255,0.2)' }}
                                                onClick={() => setSelectedUser(l)}
                                                title="Ver Hist√≥rico de Conex√µes"
                                            >
                                                üëÅÔ∏è
                                            </button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>

                {selectedUser && (
                    <VPNDetailsModal user={selectedUser} onClose={() => setSelectedUser(null)} />
                )}
            </div>
        );
    };

    const root = ReactDOM.createRoot(document.getElementById('vpn-dashboard-root'));
    root.render(<VPNDashboard />);
    {% endverbatim %}
</script>
{% endblock %}